#!/bin/bash
set -e

# Release automation script for tomics R package
# This script automates the development workflow described in README.md

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "Error: You have uncommitted changes. Please commit them first."
    exit 1
fi

# Activate conda environment
echo "Activating tomics-dev conda environment..."
source $(conda info --base)/etc/profile.d/conda.sh
conda activate tomics-dev

# Prompt for version bump type
echo "Select version bump type:"
echo "1) patch (x.y.Z)"
echo "2) minor (x.Y.0)"
echo "3) major (X.0.0)"
read -p "Enter choice [1-3]: " version_choice

case $version_choice in
    1)
        version_type="patch"
        ;;
    2)
        version_type="minor"
        ;;
    3)
        version_type="major"
        ;;
    *)
        echo "Invalid choice"
        exit 1
        ;;
esac

echo "Bumping $version_type version..."
R -e "usethis::use_version('$version_type')"

echo "Updating documentation..."
R -e "devtools::document()"

echo "Updating dependencies in DESCRIPTION..."
R -e "attachment::att_amend_desc()"

echo "Building package..."
R CMD build .

latest=$(ls -t tomics_*.tar.gz | head -n 1)
echo "Latest build: $latest"

echo "Running R CMD check..."
R CMD check $latest --no-manual --no-build-vignettes

# Extract version from filename (platform-independent)
version=$(echo "$latest" | sed 's/tomics_\(.*\)\.tar\.gz/\1/')

# Compute SHA256 (works on both Linux and macOS)
if command -v sha256sum > /dev/null 2>&1; then
    sha256=$(sha256sum "$latest" | awk '{print $1}')
else
    sha256=$(shasum -a 256 "$latest" | awk '{print $1}')
fi

echo "Version: $version"
echo "SHA256: $sha256"

echo "Updating recipe.yml..."
# Platform-independent sed (use perl instead)
perl -i -pe "s/^(\\s*)version: [0-9]+\\.[0-9]+\\.[0-9]+/\${1}version: $version/" recipe.yml
perl -i -pe "s/sha256: .*/sha256: $sha256/" recipe.yml

echo "Syncing dependencies from DESCRIPTION to recipe.yml..."
# Create a temporary R script to extract and format dependencies
Rscript - <<'EOF'
desc <- read.dcf("DESCRIPTION")

# Get Imports
imports <- desc[1, "Imports"]
imports <- gsub("\n", "", imports)
imports <- strsplit(imports, ",")[[1]]
imports <- trimws(imports)

# Get Suggests
suggests <- desc[1, "Suggests"]
suggests <- gsub("\n", "", suggests)
suggests <- strsplit(suggests, ",")[[1]]
suggests <- trimws(suggests)

# Format for recipe.yml (convert to lowercase r- prefix)
format_dep <- function(dep) {
  # Extract package name and version constraint
  parts <- strsplit(dep, "\\(")[[1]]
  pkg <- trimws(parts[1])
  
  # Skip base R packages
  base_pkgs <- c("stats", "utils", "graphics", "grDevices", "methods", "base")
  if (pkg %in% base_pkgs) return(NULL)
  
  # Convert to conda format
  conda_pkg <- paste0("r-", tolower(pkg))
  
  if (length(parts) > 1) {
    version <- gsub("[()]", "", parts[2])
    version <- trimws(version)
    version <- gsub(">=", "(>=", version)
    version <- gsub("$", ")", version)
    conda_pkg <- paste0(conda_pkg, " ", version)
  }
  
  return(conda_pkg)
}

host_deps <- c("r-base >= {{ r_version }}")
run_deps <- c("r-base")

for (dep in imports) {
  formatted <- format_dep(dep)
  if (!is.null(formatted)) {
    host_deps <- c(host_deps, formatted)
    run_deps <- c(run_deps, formatted)
  }
}

test_deps <- c()
for (dep in suggests) {
  formatted <- format_dep(dep)
  if (!is.null(formatted)) {
    test_deps <- c(test_deps, formatted)
  }
}

# Write to temporary files
writeLines(host_deps, "tmp_host_deps.txt")
writeLines(run_deps, "tmp_run_deps.txt")
writeLines(test_deps, "tmp_test_deps.txt")
EOF

# Now update recipe.yml with the new dependencies using Python
python3 - <<'EOF'
import re

with open("recipe.yml", "r") as f:
    content = f.read()

# Read the dependency lists
with open("tmp_host_deps.txt", "r") as f:
    host_deps = [line.strip() for line in f if line.strip()]

with open("tmp_run_deps.txt", "r") as f:
    run_deps = [line.strip() for line in f if line.strip()]

with open("tmp_test_deps.txt", "r") as f:
    test_deps = [line.strip() for line in f if line.strip()]

# Replace host dependencies
host_section = "  host:\n  - " + "\n  - ".join(host_deps)
content = re.sub(
    r"(requirements:\n)  host:\n(?:  - .*\n)+",
    r"\1" + host_section + "\n",
    content
)

# Replace run dependencies
run_section = "  run:\n  - " + "\n  - ".join(run_deps)
content = re.sub(
    r"(  host:\n(?:  - .*\n)+)  run:\n(?:  - .*\n)+",
    r"\1" + run_section + "\n",
    content
)

# Replace test dependencies
test_section = "    run:\n    - " + "\n    - ".join(test_deps)
content = re.sub(
    r"(  requirements:\n)    run:\n(?:    - .*\n)+",
    r"\1" + test_section + "\n",
    content
)

with open("recipe.yml", "w") as f:
    f.write(content)

print("Dependencies synced successfully!")
EOF

# Clean up temporary files
rm -f tmp_host_deps.txt tmp_run_deps.txt tmp_test_deps.txt

echo "Staging changes for commit..."
git add man DESCRIPTION NAMESPACE recipe.yml

echo "Amending commit..."
git commit --amend --no-edit

echo "Creating git tag..."
git tag "v$version"

read -p "Push to remote and create release? [y/N]: " push_choice
if [[ $push_choice =~ ^[Yy]$ ]]; then
    current_branch=$(git branch --show-current)
    echo "Pushing branch $current_branch..."
    git push origin "$current_branch"
    
    echo "Pushing tag v$version..."
    git push -f origin "v$version"
    
    echo "Creating GitHub release..."
    gh release create "v$version" $latest --notes-from-tag
    
    read -p "Build and upload to Anaconda? [y/N]: " build_choice
    if [[ $build_choice =~ ^[Yy]$ ]]; then
        echo "Select target platform:"
        echo "1) linux-64"
        echo "2) osx-arm64"
        read -p "Enter choice [1-2]: " platform_choice
        
        case $platform_choice in
            1)
                target_platform="linux-64"
                ;;
            2)
                target_platform="osx-arm64"
                ;;
            *)
                echo "Invalid choice"
                exit 1
                ;;
        esac
        
        echo "Building with rattler-build for $target_platform..."
        rattler-build build --recipe recipe.yml --output-dir ../r-tomics --target-platform $target_platform
        
        read -p "Upload to Anaconda? [y/N]: " upload_choice
        if [[ $upload_choice =~ ^[Yy]$ ]]; then
            echo "Uploading to Anaconda..."
            rattler-build upload anaconda $(ls ../r-tomics/$target_platform/r-tomics-$version-*.conda) --owner twillis209
            echo "Package uploaded successfully!"
        fi
    fi
else
    echo "Skipping push and release creation."
    echo "You can manually push later with:"
    echo "  git push origin $(git branch --show-current)"
    echo "  git push -f origin v$version"
    echo "  gh release create v$version $latest --notes-from-tag"
fi

echo "Release process complete!"
